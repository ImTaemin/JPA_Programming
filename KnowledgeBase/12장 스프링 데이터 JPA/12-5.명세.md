# π“ƒ λ…μ„Έ
λ„λ©”μΈ μ£Όλ„ μ„¤κ³„(DDD)λ” **λ…μ„Έ**(SPECIFICATION)λΌλ” κ°λ…μ„ μ†κ°ν•λ”λ°, μ¤ν”„λ§ λ°μ΄ν„° JPAλ” `JPA Criteria`λ΅ μ΄ κ°λ…μ„ μ‚¬μ©ν•  μ μλ„λ΅ μ§€μ›ν•λ‹¤.

λ…μ„Έλ¥Ό μ΄ν•΄ν•κΈ° μ„ν• ν•µμ‹¬ λ‹¨μ–΄λ” **μ μ–΄(predcate)** μΈλ° λ‹¨μν **μ°Έμ΄λ‚ κ±°μ§“μΌλ΅ ν‰κ°€**λλ‹¤. κ·Έλ¦¬κ³  `AND`, `OR` κ°™μ€ μ—°μ‚°μλ΅ μ΅°ν•©ν•  μ μλ‹¤.   
μλ¥Ό λ“¤μ–΄ λ°μ΄ν„°λ¥Ό κ²€μƒ‰ν•κΈ° μ„ν• μ μ•½ μ΅°κ±΄ ν•λ‚ν•λ‚λ¥Ό **μ μ–΄**λΌ ν•  μ μλ‹¤.   

μ¤ν”„λ§ λ°μ΄ν„° JPAλ” `org.springframework.data.jpa.domain.Specification` ν΄λμ¤λ΅ μ •μν–λ‹¤.   
`Specification`μ€ μ»΄ν¬μ§€νΈ ν¨ν„΄μΌλ΅ κµ¬μ„±λμ–΄ μμ–΄ μ—¬λ¬ `Specification`μ„ μ΅°ν•©ν•  μ μλ‹¤.   
λ”°λΌμ„ λ‹¤μ–‘ν• κ²€μƒ‰μ΅°κ±΄μ„ μ΅°λ¦½ν•΄ μƒλ΅μ΄ κ²€μƒ‰μ΅°κ±΄μ„ μ‰½κ² λ§λ“¤ μ μλ‹¤.

λ…μ„Έ κΈ°λ¥μ„ μ‚¬μ©ν•λ ¤λ©΄ [JpaSpecificationExecutor](https://docs.spring.io/spring-data/jpa/docs/current/api/org/springframework/data/jpa/repository/JpaSpecificationExecutor.html) μΈν„°νμ΄μ¤λ¥Ό μƒμ†λ°›μΌλ©΄ λλ‹¤.
```java
//JpaSpecificationExecutor μƒμ†
public interface OrderRepository extends JpaRepository<Order, Long>, JpaSpecificationExecutor<Order>{...}
```

```java
//JpaSpecificationExecutor μΈν„°νμ΄μ¤
public interface JpaSpecificationExecutor<T>{
    T findOne(Specification<T> spec);
    List<T> findAll(Specification<T> spec);
    Page<T> findAll(Specification<T> spec, Pageable pageable);
    List<T> findAll(Specification<T> spec, Sort sort);
    long count(Specification<T> spec);
}
```
`JpaSpecificationExecutor`μ λ©”μ†λ“λ“¤μ€ `Specification`μ„ νλΌλ―Έν„°λ΅ λ°›μ•„μ„ κ²€μƒ‰ μ΅°κ±΄μΌλ΅ μ‚¬μ©ν•λ‹¤.
```java
//λ…μ„Έ μ‚¬μ© μ½”λ“
import static org.springframework.data.jpa.domain.Specifications.*; //where
import static org.tmkim.jpashop.domain.spec.OrderSpec.*;

public List<Order> findOrders(String name){
    List<Order> result = orderRepository.findAll(where(memberName(name)).and(isOrderStatus()));
}
```
`Specification`λ” λ…μ„Έλ“¤μ„ μ΅°λ¦½ν•  μ μλ„λ΅ λ„μ™€μ£Όλ” ν΄λμ¤λ‹¤.(`where()`, `and()`, `or()`, `not()` λ©”μ†λ“λ¥Ό μ κ³µ)   
`findAll()`μ„ λ³΄λ©΄ νμ› μ΄λ¦„ λ…μ„Έ(`memberName`)μ™€ μ£Όλ¬Έ μƒνƒ λ…μ„Έ(`isOrderStatus`)λ¥Ό `and`λ΅ μ΅°ν•©ν•΄μ„ κ²€μƒ‰ μ΅°κ±΄μΌλ΅ μ‚¬μ©ν•λ‹¤.   
λ…μ„Έ κΈ°λ¥μ„ μ‚¬μ©ν•  λ• `import static`μ„ μ μ©ν•λ©΄ μ½κΈ° μ‰¬μ΄ μ½”λ“κ°€ λλ‹¤.
```java
//OrderSpec λ…μ„Έ μ •μ μ½”λ“
public class OrderSpec{

    public static Specification<Order> memberName(final String membeName){
        return new Specification<Order>(){
            public Predicate toPredicate(Root<Order> root, CriteriaQuery<?> query, CriteriaBuilder builder){
                
                if(StringUtils.isEmpty(memberName))
                    return null;

                Join<Order, Member> m = root.join("member", JoinType.INNER); //νμ›κ³Ό μ΅°μΈ

                return builder.equal(m.get("name"), memberName);
            }
        }
    }

    public static Specification<Order> isOrderStatus(){
        return new Specification<Order>(){
            public Predicate toPredicate(Root<Order> root, CriteriaQuery<?> query, CriteriaBuilder builder){
                return builder.equal(root.get("status"), OrderStatus.ORDER);
            }
        }
    }
}
```
λ…μ„Έλ¥Ό μ •μν•λ ¤λ©΄ `Specification` μΈν„°νμ΄μ¤λ¥Ό κµ¬ν„ν•λ©΄ λλ‹¤.(μ—¬κΈ°μ„  νΈμμƒ λ¬΄λ… ν΄λμ¤ μ‚¬μ©)   
λ…μ„Έλ¥Ό μ •μν•  λ•λ” `toPredicate(...)` λ©”μ†λ“λ§ κµ¬ν„ν•λ©΄ λλ”λ° JPA Criteriaμ `Root`, `CriteriaQuery`, `CriteriaBuilder` ν΄λμ¤κ°€ νλΌλ―Έν„°λ΅ μ£Όμ–΄μ§€λ”λ°,   
μ΄ νλΌλ―Έν„°λ“¤μ„ ν™μ©ν•΄μ„ μ μ ν• κ²€μƒ‰ μ΅°κ±΄μ„ λ°ν™ν•λ©΄ λλ‹¤.