# âœ” í”„ë¡ì‹œ ì‹¬í™” ì£¼ì œ

- [1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ í”„ë¡ì‹œ](#1-ì˜ì†ì„±-ì»¨í…ìŠ¤íŠ¸ì™€-í”„ë¡ì‹œ)
- [2. í”„ë¡ì‹œ íƒ€ì… ë¹„êµ](#2-í”„ë¡ì‹œ-íƒ€ì…-ë¹„êµ)
- [3. í”„ë¡ì‹œ ë™ë“±ì„± ë¹„êµ](#3-í”„ë¡ì‹œ-ë™ë“±ì„±-ë¹„êµ)
- [ì •ë¦¬](#ğŸ“-ì •ë¦¬)

í”„ë¡ì‹œëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ìƒì†ë°›ì•„ì„œ ë§Œë“¤ì–´ì§€ë¯€ë¡œ ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ëŠ” ì—”í‹°í‹°ê°€ í”„ë¡ì‹œì¸ì§€ ì›ë³¸ ì—”í‹°í‹°ì¸ì§€ êµ¬ë¶„í•˜ì§€ ì•Šê³  ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤.  
ë”°ë¼ì„œ ì›ë³¸ ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ë‹¤ê°€ ì§€ì—° ë¡œë”©ì„ í•˜ë ¤ê³  í”„ë¡ì‹œë¡œ ë³€ê²½í•´ë„ í´ë¼ì´ì–¸íŠ¸ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìˆ˜ì •í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.   
í•˜ì§€ë§Œ í”„ë¡ì‹œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ì‹ì˜ ê¸°ìˆ ì ì¸ í•œê³„ë¡œ ì¸í•´ ì˜ˆìƒí•˜ì§€ ëª»í•œ ë¬¸ì œë“¤ì´ ë°œìƒí•˜ê¸°ë„ í•œë‹¤.

## 1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì™€ í”„ë¡ì‹œ
ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ìì‹ ì´ ê´€ë¦¬í•˜ëŠ” ì˜ì† ì—”í‹°í‹°ì˜ ë™ì¼ì„±ì„ ë³´ì¥í•œë‹¤.   
í”„ë¡ì‹œë¡œ ì¡°íšŒí•œ ì—”í‹°í‹°ì˜ ë™ì¼ì„±ë„ ë³´ì¥í• ê¹Œ?
```java
@Test
public void persistContextAndProxy(){
    Member newMember = new Member("member1", "íšŒì›1");
    em.persist(newMember);
    em.flush();
    em.clear();

    Member refMember = em.getReference(Member.class, "member1");
    Member findMember = em.find(Member.class, "member1");

    System.out.println("refMember Type = " + refMember.getClass());
    System.out.println("findMember Type = " + findMember.getClass());

    Assert.assertTrue(refMember == findMember); //ì„±ê³µ
}
```
ì¶œë ¥ ê²°ê³¼   
```
refMember Type = class jpabook.advanced.Member_$$_jvst843_0
findMember Type = class jpabook.advanced.Member_$$_jvst843_0
```

ë¨¼ì € member1ì„ `em.getReference()`ë¥¼ ì‚¬ìš©í•´ í”„ë¡ì‹œë¡œ ì¡°íšŒí–ˆë‹¤.   
ë‹¤ìŒìœ¼ë¡œ ê°™ì€ member1ì„ `em.find()`ë¥¼ ì‚¬ìš©í•´ ì¡°íˆí–ˆë‹¤.   
`refMember`ëŠ” í”„ë¡ì‹œê³  `findMember`ëŠ” ì›ë³¸ ì—”í‹°í‹°ì´ë¯€ë¡œ ì„œë¡œ ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤ë¡œ ìƒê°í•  ìˆ˜ ìˆì§€ë§Œ ì´ë ‡ê²Œ ë˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ê°€ ì˜ì† ì—”í‹°í‹°ì˜ ë™ì¼ì„±ì„ ë³´ì¥í•˜ì§€ ëª»í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•œë‹¤.  

ê·¸ë˜ì„œ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” í”„ë¡ì‹œë¡œ ì¡°íšŒëœ ì—”í‹°í‹°ì— ëŒ€í•´ì„œ ê°™ì€ ì—”í‹°í‹°ë¥¼ ì°¾ëŠ” ìš”ì²­ì´ ì˜¤ë©´ ì›ë³¸ ì—”í‹°í‹°ê°€ ì•„ë‹Œ ì²˜ìŒ ì¡°íšŒëœ í”„ë¡ì‹œë¥¼ ë°˜í™˜í•œë‹¤.   
ì½”ë“œì—ì„œ member1 ì—”í‹°í‹°ë¥¼ í”„ë¡ì‹œëŸ¬ ì²˜ìŒ ì¡°íšŒí–ˆê¸° ë•Œë¬¸ì— ì´í›„ì— `em.find()`ë¥¼ ì‚¬ìš©í•´ì„œ ê°™ì€ member1ì„ ì°¾ì•„ë„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì›ë³¸ì´ ì•„ë‹Œ í”„ë¡ì‹œë¥¼ ë°˜í™˜í•œë‹¤.   
ì¶œë ¥ ê²°ê³¼ë¥¼ ë³´ë©´ `$$_jvst843_0`ì´ ë¶™ì–´ìˆìœ¼ë¯€ë¡œ í”„ë¡ì‹œë¡œ ì¡°íšŒëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê·¸ë¦¬ê³  ë§ˆì§€ë§‰ì— `assertTrue` ê²€ì¦ ì½”ë“œë¥¼ í†µí•´ ë‘˜ì´ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤ì¸ ê²ƒì„ ì•Œ ìˆ˜ ìˆë‹¤.   

ë”°ë¼ì„œ í”„ë¡ì‹œë¡œ ì¡°íšŒí•´ë„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì˜ì† ì—”í‹°í‹°ì˜ ë™ì¼ì„±ì„ ë³´ì¥í•œë‹¤.

```java
//ì›ë³¸ ë¨¼ì € ì¡°íšŒí•˜ê³  ë‚˜ì„œ í”„ë¡ì‹œë¡œ ì¡°íšŒ
@Test
public void persistContextAndProxy2(){
    Member newMember = new Member("member1", "íšŒì›1");
    em.persist(newMember);
    em.flush();
    em.clear();

    Member findMember = em.find(Member.class, "member1");
    Member refMember = em.getReference(Member.class, "member1");

    System.out.println("refMember Type = " + refMember.getClass());
    System.out.println("findMember Type = " + findMember.getClass());

    Assert.assertTrue(refMember == findMember); //ì„±ê³µ
}
```
```
ì¶œë ¥ ê²°ê³¼
refMember Type = class jpabook.advanced.Member
findMember Type = class jpabook.advanced.Member
```
**ì›ë³¸ ì—”í‹°í‹°ë¥¼ ë¨¼ì € ì¡°íšŒí•˜ë©´ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ì´ë¯¸ DBì—ì„œ ì¡°íšŒí–ˆìœ¼ë¯€ë¡œ í”„ë¡ì‹œë¥¼ ë°˜í™˜í•  ì´ìœ ê°€ ì—†ë‹¤.**   
ë”°ë¼ì„œ `em.getReference()`ë¥¼ í˜¸ì¶œí•´ë„ í”„ë¡ì‹œê°€ ì•„ë‹Œ ì›ë³¸ì„ ë°˜í™˜í•œë‹¤. ë¬¼ë¡  ì´ ê²½ìš°ì—ë„ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ëŠ” ìì‹ ì´ ê´€ë¦¬í•˜ëŠ” ì˜ì† ì—”í‹°í‹°ì˜ ë™ì¼ì„±ì„ ë³´ì¥í•œë‹¤.

## 2. í”„ë¡ì‹œ íƒ€ì… ë¹„êµ
í”„ë¡ì‹œëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ìƒì† ë°›ì•„ì„œ ë§Œë“¤ì–´ì§€ë¯€ë¡œ í”„ë¡ì‹œë¡œ ì¡°íšŒí•œ ì—”í‹°í‹°ì˜ íƒ€ì…ì„ ë¹„êµí•  ë•ŒëŠ” `==` ë¹„êµë¥¼ í•˜ë©´ ì•ˆ ë˜ê³  `instanceof`ë¥¼ ì‚¬ìš©í•´ì•¼ í•œë‹¤.   
<div style="margin:auto;background-color:white; width:50%; height:100%; display:flex; flex-direction:column; color:black; font-size:26px;border:1px solid black;">
    <div style="text-align:center" width="200" height="200">
        Member
    </div>
    <div style="text-align:center" height="100%">
        <svg width="100%" height="100%" style="transform:rotate(270deg)">
            <defs>
                <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                <path d="M 0 0 L 10 5 L 0 10 z" fill="#000"/> 
            </defs> 
            <line x1="40%" y1="50%" x2="55%" y2="50%" stroke="#000" stroke-width="2" marker-end="url(#arrow)" />
        </svg>
    </div>
    <div style="text-align:center" height="200">
        Member_$$_jvsteXXX
    </div>
</div>

```java
@Test
public void compareProxyType(){
    Member newMember = new Member("member1", "íšŒì›1");
    em.persist(newMember);
    em.flush();
    em.clear();

    Member refMember = em.getReference(Member.class, "member1");

    Assert.assertFalse(Member.class == refMember.getClass()); //false
    Assert.assertTrue(refMember instanceof Member);           //true
}
```
```
ì¶œë ¥ ê²°ê³¼
refMember Type = class jpabook.advanced.Member_$$_jvstXXX
```
`refMember`ì˜ íƒ€ì…ì„ ì¶œë ¥í•´ë³´ë©´ í”„ë¡ì‹œë¡œ ì¡°íšŒí–ˆìœ¼ë¯€ë¡œ ì¶œë ¥ ê²°ê³¼ ëì— í”„ë¡ì‹œë¼ëŠ” ì˜ë¯¸ì˜ `_$$_jvstXXX`ê°€ ë¶™ì–´ ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.   

`Member.class == refMember.getClass()` ë¹„êµëŠ” ë¶€ëª¨ í´ë˜ìŠ¤ì™€ ìì‹ í´ë˜ìŠ¤ë¥¼ `==` ë¹„êµí•œ ê²ƒì´ ëœë‹¤. ë”°ë¼ì„œ ê²°ê³¼ëŠ” falseë‹¤.   
**í”„ë¡ì‹œëŠ” ì›ë³¸ ì—”í‹°í‹°ì˜ ìì‹ íƒ€ì…**ì´ë¯€ë¡œ `instanceof` ì—°ì‚°ì„ ì‚¬ìš©í•˜ë©´ ëœë‹¤.

## 3. í”„ë¡ì‹œ ë™ë“±ì„± ë¹„êµ
ì—”í‹°í‹°ì˜ ë™ë“±ì„±ì„ ë¹„êµí•˜ë ¤ë©´ ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ë¥¼ ì‚¬ìš©í•´ì„œ `equals()` ë©”ì†Œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í•˜ê³  ë¹„êµí•˜ë©´ ëœë‹¤.   
ê·¸ëŸ°ë° IDEë‚˜ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•´ì„œ êµ¬í˜„í•œ `equals()` ë©”ì†Œë“œë¡œ ì—”í‹°í‹°ë¥¼ ë¹„êµí•  ë•Œ, ë¹„êµ ëŒ€ìƒì´ ì›ë³¸ ì—”í‹°í‹°ë©´ ë¬¸ì œê°€ ì—†ì§€ë§Œ í”„ë¡ì‹œë©´ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤.
```java
@Entity
public class Member{

    @Id
    private String id;
    private String name;
    ...

    @Override
    public boolean equals(Object obj){
        if(this == obj) return true;
        if(obj == null) return false;
        if(this.getClass() != obj.getClass()) return false; //...1

        Member member = (Member) obj;

        // ...2
        if(name != null ? !name.equals(member.name) : member.name != null){
            return false;
        }

        return true;
    }

    @Override
    public int hashCode(){
        return name != null ? name.hashCode() : 0;
    }
}
```
íšŒì› ì—”í‹°í‹°ëŠ” name í•„ë“œë¥¼ ë¹„ì¦ˆë‹ˆìŠ¤ í‚¤ë¡œ ì‚¬ìš©í•´ì„œ `equals()` ë©”ì†Œë“œë¥¼ ì˜¤ë²„ë¼ì´ë”©í–ˆë‹¤.(nameì´ ì¤‘ë³µx ê°€ì •)
```java
@Test
public void compareProxyEquiv(){
    Member saveMember = new Member("member1", "íšŒì›1");
    em.persist(saveMember);
    em.flush();
    em.clear();

    Member newMember = new Member("member1", "íšŒì›1");
    Member refMember = em.getReference(Member.class, "member1");

    Assert.assertTrue(newMember.equals(refMember));
}
```
<p align="center"><img src="https://i.ibb.co/vzVk4dy/image.png" width="60%"/><br>í”„ë¡ì‹œ ë™ë“±ì„± ë¹„êµ</p>

ìƒˆë¡œ ìƒì„±í•œ íšŒì› `newMember`ì™€ í”„ë¡ì‹œë¡œ ì¡°íšŒí•œ íšŒì› `refMember`ì˜ `name` ì†ì„±ì€ ë‘˜ ë‹¤ íšŒì›1ë¡œ ê°™ìœ¼ë¯€ë¡œ ë™ë“±ì„± ë¹„êµë¥¼ í•˜ë©´ ì„±ê³µí•  ê²ƒ ê°™ë‹¤. ë”°ë¼ì„œ `newMember.equals(refMember)`ì˜ ê²°ê³¼ëŠ” `true`ë¥¼ ê¸°ëŒ€í–ˆì§€ë§Œ ì‹¤í–‰í•´ë³´ë©´ `false`ê°€ ë‚˜ì˜¤ë©´ì„œ í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í•œë‹¤. ì´ í…ŒìŠ¤íŠ¸ë¥¼ í”„ë¡ì‹œê°€ ì•„ë‹Œ ì›ë³¸ ì—”í‹°í‹°ë¥¼ ì¡°íšŒí•´ì„œ ë¹„êµí•˜ë©´ ì„±ê³µí•œë‹¤.

í”„ë¡ì‹œì™€ `equals()` ë¹„êµë¥¼ í•  ë•ŒëŠ” ëª‡ê°€ì§€ ì£¼ì˜ì ì´ ìˆë‹¤.
```java
if(this.getClass() != obj.getClass()) return false;
```
1. ì—¬ê¸°ì„œ íƒ€ì…ì„ ë™ì¼ì„±(==) ë¹„êµí•œë‹¤.   
ì•ì„œ í”„ë¡ì‹œëŠ” ì›ë³¸ì„ ìƒì†ë°›ì€ ìì‹ íƒ€ì…ì´ë¯€ë¡œ í”„ë¡ì‹œì˜ íƒ€ì…ì„ ë¹„êµí•  ë•ŒëŠ” `==` ë¹„êµê°€ ì•„ë‹Œ **`instanceof`ë¥¼ ì‚¬ìš©**í•´ì•¼ í•œë‹¤ê³  ì„¤ëª…í–ˆë‹¤.   
ë”°ë¼ì„œ ì•„ë˜ì™€ ê°™ì´ ë³€ê²½í•´ì•¼ í•œë‹¤.
    ```java
    if(!(obj instanceof Member)) return false;
    ```
```java
Member member = (Member) obj; //memberëŠ” í”„ë¡ì‹œë‹¤.

if(name != null ? !name.equals(member.name) : member.name != null){
    return false;
}
```
2. `member.name`ì„ ë³´ë©´ í”„ë¡ì‹œì˜ ë©¤ë²„ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼í•œë‹¤.   
    <p align="center"><img src="https://i.ibb.co/8xjTm6B/image.png" width="60%"/><br>í”„ë¡ì‹œ í•„ë“œ ì§ì ‘ ì ‘ê·¼</p>

    `equals()` ë©”ì†Œë“œë¥¼ êµ¬í˜„í•  ë•ŒëŠ” ì¼ë°˜ì ìœ¼ë¡œ ë©¤ë²„ë³€ìˆ˜ë¥¼ ì§ì ‘ ë¹„êµí•˜ëŠ”ë°, í”„ë¡ì‹œì˜ ê²½ìš°ëŠ” ë¬¸ì œê°€ ëœë‹¤.   
    **í”„ë¡ì‹œëŠ” ì‹¤ì œ ë°ì´í„°ë¥¼ ê°€ì§€ê³  ìˆì§€ ì•Šë‹¤**. ë”°ë¼ì„œ í”„ë¡ì‹œì˜ ë©¤ë²„ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼í•˜ë©´ ì•„ë¬´ê°’ë„ ì¡°íšŒí•  ìˆ˜ ì—†ê¸° ë•Œë¬¸ì— `member.name`ì˜ ê²°ê³¼ëŠ” `null`ì´ ë°˜í™˜ë˜ê³  `equals()`ëŠ” `false`ë¥¼ ë°˜í™˜í•˜ê²Œ ëœë‹¤.
    
    `name` ë©¤ë²„ë³€ìˆ˜ê°€ `private`ì´ë¯€ë¡œ ì¼ë°˜ì ì¸ ìƒí™©ì—ì„œëŠ” í”„ë¡ì‹œì˜ ë©¤ë²„ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼í•˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•˜ì§€ ì•Šì§€ë§Œ `equals()` ë©”ì†Œë“œëŠ” ìì‹ ì„ ë¹„êµí•˜ê¸° ë•Œë¬¸ì— `private` ë©¤ë²„ë³€ìˆ˜ì—ë„ ì ‘ê·¼í•  ìˆ˜ ìˆë‹¤.    
    
    í”„ë¡ì‹œì˜ ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•ŒëŠ” **ì ‘ê·¼ìë¥¼ ì‚¬ìš©**í•´ì•¼ í•œë‹¤.
    ```java
    Member member = (Member) obj;

    if(name != null ? !name.equals(member.getName()) : member.getName() != null)
        return false;
    ```
    <p align="center"><img src="https://i.ibb.co/Pc1g4DN/image.png" width="60%"/><br>í”„ë¡ì‹œ ì ‘ê·¼ì ì‚¬ìš©</p>

    ```java
    //equals() ìˆ˜ì •í•œ ì „ì²´ ì½”ë“œ
    @Override
    public boolean equals(Object obj){
        if(this == obj) return true;
        if(!(obj instanceof Member)) return false;

        Member member = (Member) obj;

        if(name != null ? !name.equals(member.getName()) : member.getName() != null){
            return false;
        }

        return true;
    }
    ```
    ìˆ˜ì •í•œ ì½”ë“œë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ë©´ `newMember.equals(refMember)`ì˜ ê²°ê³¼ë¡œ `true`ê°€ ë°˜í™˜ë˜ê³  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œë‹¤.

## ğŸ“ ì •ë¦¬
í”„ë¡ì‹œì˜ ë™ë“±ì„± ë¹„êµ ì‹œ ì£¼ì˜ ì‚¬í•­ 2ê°€ì§€
- í”„ë¡ì‹œì˜ íƒ€ì… ë¹„êµëŠ” `==` ë¹„êµ ëŒ€ì‹  **`instanceof`ë¥¼ ì‚¬ìš©**í•´ì•¼ í•œë‹¤.
- í”„ë¡ì‹œì˜ ë©¤ë²„ë³€ìˆ˜ì— ì§ì ‘ ì ‘ê·¼í•˜ë©´ ì•ˆ ë˜ê³  ëŒ€ì‹  **ì ‘ê·¼ì ë©”ì†Œë“œë¥¼ ì‚¬ìš©**í•´ì•¼ í•œë‹¤.